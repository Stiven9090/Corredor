-- TIENDA DE VIDEOJUEGOS


CREATE DATABASE TIENDA_GAMES;
USE TIENDA_GAMES;


CREATE TABLE Cliente (
    id_cliente INT PRIMARY KEY AUTO_INCREMENT,
        nombre VARCHAR(50) NOT NULL,
            email VARCHAR(80) UNIQUE NOT NULL,
                telefono VARCHAR(15),
                    fecha_registro DATE DEFAULT (CURDATE())
                    );

                    CREATE TABLE Categoria (
                        id_categoria INT PRIMARY KEY AUTO_INCREMENT,
                            nombre VARCHAR(30) NOT NULL,
                                descripcion VARCHAR(100)
                                );

                                CREATE TABLE Videojuego (
                                    id_juego INT PRIMARY KEY AUTO_INCREMENT,
                                        titulo VARCHAR(80) NOT NULL,
                                            precio DECIMAL(8,2) NOT NULL,
                                                stock INT DEFAULT 0,
                                                    id_categoria INT,
                                                        plataforma ENUM('PC', 'PS5', 'Xbox', 'Switch') NOT NULL,
                                                            clasificacion ENUM('E', 'T', 'M', 'RP') DEFAULT 'E',
                                                                FOREIGN KEY (id_categoria) REFERENCES Categoria(id_categoria)
                                                                );

                                                                CREATE TABLE Venta (
                                                                    id_venta INT PRIMARY KEY AUTO_INCREMENT,
                                                                        id_cliente INT NOT NULL,
                                                                            fecha_venta DATETIME DEFAULT CURRENT_TIMESTAMP,
                                                                                total DECIMAL(10,2) NOT NULL,
                                                                                    descuento DECIMAL(5,2) DEFAULT 0,
                                                                                        FOREIGN KEY (id_cliente) REFERENCES Cliente(id_cliente)
                                                                                        );

                                                                                        CREATE TABLE Detalle_Venta (
                                                                                            id_venta INT,
                                                                                                id_juego INT,
                                                                                                    cantidad INT NOT NULL,
                                                                                                        precio_unitario DECIMAL(8,2) NOT NULL,
                                                                                                            PRIMARY KEY (id_venta, id_juego),
                                                                                                                FOREIGN KEY (id_venta) REFERENCES Venta(id_venta),
                                                                                                                    FOREIGN KEY (id_juego) REFERENCES Videojuego(id_juego),

                                                                                                                    INSERT INTO Cliente (nombre, email, telefono) VALUES
                                                                                                                    ('Ana García', 'ana.garcia@email.com', '3001234567'),
                                                                                                                    ('Carlos López', 'carlos.lopez@email.com', '3009876543'),
                                                                                                                    ('María Rodríguez', 'maria.rodriguez@email.com', '3005555666'),

                                                                                                                    INSERT INTO Categoria (nombre, descripcion) VALUES
                                                                                                                    ('Acción', 'Juegos de acción y aventura'),
                                                                                                                    ('RPG', 'Juegos de rol y fantasía'),
                                                                                                                    ('Deportes', 'Simuladores deportivos'),
                                                                                                                    ('Estrategia', 'Juegos de estrategia y tácticas');

                                                                                                                    INSERT INTO Videojuego (titulo, precio, stock, id_categoria, plataforma, clasificacion) VALUES
                                                                                                                    ('Call of Duty MW3', 59.99, 15, 1, 'PS5', 'M'),
                                                                                                                    ('FIFA 24', 49.99, 20, 3, 'PS5', 'E'),
                                                                                                                    ('The Witcher 3', 29.99, 8, 2, 'PC', 'M'),
                                                                                                                    ('Age of Empires IV', 39.99, 12, 4, 'PC', 'T'),
                                                                                                                    ('Super Mario Wonder', 54.99, 25, 1, 'Switch', 'E'),
                                                                                                                    ('Cyberpunk 2077', 24.99, 5, 1, 'Xbox', 'M');

                                                                                                                    INSERT INTO Venta (id_cliente, total, descuento) VALUES
                                                                                                                    (1, 109.98, 5.00),
                                                                                                                    (2, 49.99, 0.00),
                                                                                                                    (3, 69.98, 10.00),
                                                                                                                    (1, 54.99, 0.00);

                                                                                                                    INSERT INTO Detalle_Venta (id_venta, id_juego, cantidad, precio_unitario) VALUES
                                                                                                                    (1, 1, 1, 59.99),
                                                                                                                    (1, 3, 1, 29.99),
                                                                                                                    (2, 2, 1, 49.99),
                                                                                                                    (3, 4, 1, 39.99),
                                                                                                                    (3, 6, 1, 24.99),
                                                                                                                    (4, 5, 1, 54.99),


                                                                                                                        UPPER(titulo) AS juego_mayuscula,
                                                                                                                            CONCAT('$', FORMAT(precio, 2)) AS precio_formato,
                                                                                                                                LEFT(titulo, 10) AS titulo_corto,
                                                                                                                                    LENGTH(titulo) AS longitud_titulo
                                                                                                                                    FROM Videojuego
                                                                                                                                    ORDER BY precio DESC;


                                                                                                                                        c.nombre AS cliente,
                                                                                                                                            COUNT(v.id_venta) AS total_compras,
                                                                                                                                                SUM(v.total) AS dinero_gastado,
                                                                                                                                                    AVG(v.total) AS promedio_por_compra,
                                                                                                                                                        MAX(v.fecha_venta) AS ultima_compra
                                                                                                                                                        FROM Cliente c
                                                                                                                                                        LEFT JOIN Venta v ON c.id_cliente = v.id_cliente
                                                                                                                                                        GROUP BY c.id_cliente, c.nombre
                                                                                                                                                        ORDER BY dinero_gastado DESC;


                                                                                                                                                        SELECT 
                                                                                                                                                            vj.titulo,
                                                                                                                                                                vj.plataforma,
                                                                                                                                                                    cat.nombre AS categoria,
                                                                                                                                                                        SUM(dv.cantidad) AS total_vendido,
                                                                                                                                                                            SUM(dv.cantidad * dv.precio_unitario) AS ingresos_generados
                                                                                                                                                                            FROM Videojuego vj
                                                                                                                                                                            JOIN Detalle_Venta dv ON vj.id_juego = dv.id_juego
                                                                                                                                                                            JOIN Categoria cat ON vj.id_categoria = cat.id_categoria
                                                                                                                                                                            GROUP BY vj.id_juego, vj.titulo, vj.plataforma, cat.nombre
                                                                                                                                                                            ORDER BY total_vendido DESC
                                                                                                                                                                            LIMIT 3;


                                                                                                                                                                            DELIMITER //
                                                                                                                                                                            CREATE PROCEDURE RegistrarVenta(
                                                                                                                                                                                IN p_id_cliente INT,
                                                                                                                                                                                    IN p_id_juego INT,
                                                                                                                                                                                        IN p_cantidad INT
                                                                                                                                                                                        )
                                                                                                                                                                                        BEGIN
                                                                                                                                                                                            DECLARE v_precio DECIMAL(8,2);
                                                                                                                                                                                                DECLARE v_stock INT;
                                                                                                                                                                                                    DECLARE v_total DECIMAL(10,2);
                                                                                                                                                                                                        DECLARE v_id_venta INT;
                                                                                                                                                                                                            
                                                                                                                                                                                                                 INTO v_precio, v_stock
                                                                                                                                                                                                                     FROM Videojuego WHERE id_juego = p_id_juego;
                                                                                                                                                                                                                         
                                                                                                                                                                                                                             IF v_stock >= p_cantidad THEN
                                                                                                                                                                                                                                     SET v_total = v_precio * p_cantidad;
                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                              (id_cliente, total) VALUES (p_id_cliente, v_total);
                                                                                                                                                                                                                                                      SET v_id_venta = LAST_INSERT_ID();
                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                              INSERT INTO Detalle_Venta (id_venta, id_juego, cantidad, precio_unitario)
                                                                                                                                                                                                                                                                                      VALUES (v_id_venta, p_id_juego, p_cantidad, v_precio);
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                              UPDATE Videojuego 
                                                                                                                                                                                                                                                                                                                      SET stock = stock - p_cantidad 
                                                                                                                                                                                                                                                                                                                              WHERE id_juego = p_id_juego;
                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                          SELECT 'Venta registrada exitosamente' AS resultado;
                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                   SELECT 'Stock insuficiente' AS resultado;
                                                                                                                                                                                                                                                                                                                                                       END IF;
                                                                                                                                                                                                                                                                                                                                                       END //
                                                                                                                                                                                                                                                                                                                                                       DELIMITER ;

                                                                                                                                                                                                                                                                                                                                                       SELECT 
                                                                                                                                                                                                                                                                                                                                                           titulo,
                                                                                                                                                                                                                                                                                                                                                               plataforma,
                                                                                                                                                                                                                                                                                                                                                                   stock,
                                                                                                                                                                                                                                                                                                                                                                       precio,
                                                                                                                                                                                                                                                                                                                                                                           CASE 
                                                                                                                                                                                                                                                                                                                                                                                   WHEN stock = 0 THEN 'AGOTADO'
                                                                                                                                                                                                                                                                                                                                                                                           WHEN stock <= 5 THEN 'CRÍTICO'
                                                                                                                                                                                                                                                                                                                                                                                                   WHEN stock <= 10 THEN 'BAJO'
                                                                                                                                                                                                                                                                                                                                                                                                           ELSE 'NORMAL'
                                                                                                                                                                                                                                                                                                                                                                                                               END AS estado_stock
                                                                                                                                                                                                                                                                                                                                                                                                               FROM Videojuego
                                                                                                                                                                                                                                                                                                                                                                                                               WHERE stock <= 10
                                                                                                                                                                                                                                                                                                                                                                                                               ORDER BY stock ASC;


                                                                                                                                                                                                                                                                                                                                                                                                               SELECT 
                                                                                                                                                                                                                                                                                                                                                                                                                   cat.nombre AS categoria,
                                                                                                                                                                                                                                                                                                                                                                                                                       COUNT(DISTINCT dv.id_venta) AS ventas_realizadas,
                                                                                                                                                                                                                                                                                                                                                                                                                           SUM(dv.cantidad) AS juegos_vendidos,
                                                                                                                                                                                                                                                                                                                                                                                                                               SUM(dv.cantidad * dv.precio_unitario) AS ingresos_totales,
                                                                                                                                                                                                                                                                                                                                                                                                                                   ROUND(AVG(dv.precio_unitario), 2) AS precio_promedio
                                                                                                                                                                                                                                                                                                                                                                                                                                   FROM Categoria cat
                                                                                                                                                                                                                                                                                                                                                                                                                                   JOIN Videojuego vj ON cat.id_categoria = vj.id_categoria
                                                                                                                                                                                                                                                                                                                                                                                                                                   JOIN Detalle_Venta dv ON vj.id_juego = dv.id_juego
                                                                                                                                                                                                                                                                                                                                                                                                                                   GROUP BY cat.id_categoria, cat.nombre
                                                                                                                                                                                                                                                                                                                                                                                                                                   ORDER BY ingresos_totales DESC;


                                                                                                                                                                                                                                                                                                                                                                                                                                   SELECT DISTINCT
                                                                                                                                                                                                                                                                                                                                                                                                                                       c.nombre,
                                                                                                                                                                                                                                                                                                                                                                                                                                           c.email,
                                                                                                                                                                                                                                                                                                                                                                                                                                               vj.titulo AS juego_mature
                                                                                                                                                                                                                                                                                                                                                                                                                                               FROM Cliente c
                                                                                                                                                                                                                                                                                                                                                                                                                                               JOIN Venta v ON c.id_cliente = v.id_cliente
                                                                                                                                                                                                                                                                                                                                                                                                                                               JOIN Detalle_Venta dv ON v.id_venta = dv.id_venta
                                                                                                                                                                                                                                                                                                                                                                                                                                               JOIN Videojuego vj ON dv.id_juego = vj.id_juego
                                                                                                                                                                                                                                                                                                                                                                                                                                               WHERE vj.clasificacion = 'M'
                                                                                                                                                                                                                                                                                                                                                                                                                                               ORDER BY c.nombre;


                                                                                                                                                                                                                                                                                                                                                                                                                                               DELIMITER //
                                                                                                                                                                                                                                                                                                                                                                                                                                               CREATE FUNCTION CalcularDescuento(total_compra DECIMAL(10,2))
                                                                                                                                                                                                                                                                                                                                                                                                                                               RETURNS DECIMAL(5,2)
                                                                                                                                                                                                                                                                                                                                                                                                                                               READS SQL DATA
                                                                                                                                                                                                                                                                                                                                                                                                                                               DETERMINISTIC
                                                                                                                                                                                                                                                                                                                                                                                                                                               BEGIN
                                                                                                                                                                                                                                                                                                                                                                                                                                                   DECLARE descuento DECIMAL(5,2) DEFAULT 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                           IF total_compra >= 100 THEN
                                                                                                                                                                                                                                                                                                                                                                                                                                                                   SET descuento = 15.00;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ELSEIF total_compra >= 75 THEN
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               SET descuento = 10.00;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ELSEIF total_compra >= 50 THEN
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           SET descuento = 5.00;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               END IF;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       RETURN descuento;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       END //
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       DELIMITER ;




                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       SELECT * FROM InventarioCritico;


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       SELECT 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           titulo,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               precio,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   CalcularDescuento(precio) AS descuento_aplicable
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   FROM Videojuego
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ORDER BY precio DESC;





                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   SELECT 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       plataforma,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           titulo,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               precio
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               FROM Videojuego v1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               WHERE precio = (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   SELECT MAX(precio)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       FROM Videojuego v2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           WHERE v2.plataforma = v1.plataforma
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ORDER BY precio DESC;